# Configuring techstacks in the repository using .techstackrc.js

## The problem

Techstacks advocate a mapping of solutions to different engineering use-cases. Each solution is
composed of a set of checks and anti-checks which resolve to a set of stricter and eslint rules.

The use-cases and its solutions are packaged into a package which is referred to as techstack
definition. A repository can use multiple use-cases and solutions from multiple techstack
definitions since each techstack definitions might not be self complete in terms of the use-cases
and solutions they provide. All this information regarding the use-cases, solutions and definitions
a repository use are documented in the root techstackrc.js config file of the repository.

## The solution

To use techstacks, we define a root `.techstackrc.js` file, which consists of

- basic configuration
- a set of definitions, use-cases and solutions used in the repository
- the use-cases and solutions that need to be applied by default to all the packages

A package can then ignore techstack, opt out of certain use-case or ignore certain eslint or
stricter rule set by configuring it in its package.json.

## Hooking techstack into eslint and stricter

In order to hook the rules generated by use-cases and their solutions into `eslint`/`stricter`, we
use functions, exposed by `@atlassian/techstack-runtime` library:

In `eslint.config.js`:

```javascript
const { eslintAdapter } = require('@atlassian/techstack-runtime');
module.exports = eslintAdapter({
  /* original eslint config */
});
```

In `stricter.config.js`:

```javascript
const { stricterAdapter } = require('@atlassian/techstack-runtime');
module.exports = stricterAdapter({
  /* original stricter config */
});
```

## Cache

Since scanning through techstack definitions, use-cases, solutions and their checks is time
consuming considering the number of package.json files we encounter, we use memory cache in
`@atlassian/techstack-runtime` to cache the generated config.

It can be changed using `TECHSTACK_CACHE_TTL` environment variable.

## Usage

### Understanding the `.techstackrc.js`

For every use-case, we mention the solutions associated with that use-case. A single solution can be
mentioned in string format whereas in case of multiple solutions, we provide an array of solutions
as strings for the use-case.

```javascript
module.exports = {
  config: {
    rootPath: '.',
    pathToPackages: 'src',
    eslintConfigPath: 'src',
  },
  repository: {
    '@atlassian/frontend': {
      'code-structure': ['tangerine-next', 'tangerine-classic'],
      /* other use-case and solutions */
    },
  },
  default: {
    '@atlassian/frontend': {
      'code-structure': 'tangerine-next',
      /* other use-case and solutions */
    },
  },
};
```

#### Config

The config key lists the `rootPath`, `pathToPackages` and path to `eslintConfigPath`.

#### Repository

The repository key lists the techstack definitions, and the use-cases and their solutions used
within the repository. It is just a superset to keep track of all the use-cases and solutions within
the repository.

#### Default

The use-cases and solutions mentioned in the default key are applied by default to all the packages.

### How does a package opt in to techstack

All packages by default are assumed to use the use-cases and solutions defined in the default key of
`.techstackrc.js`. To use some other use-case and solutions mentioned within the repository set of
use-cases and solutions, a package can define them in the techstack key of `package.json`. Example:
A package might opt for `tangerine-classic` code-structure instead of `tangerine-next`. The
`techstack` field in the package.json would then look like:

```json
{
  "name": "package-a",
  "techstack": {
    "code-structure": "tangerine-classic"
  }
}
```

With this configuration in `package.json`, this package is assumed to use all use-cases from default
techstack with `code-structure` use-case overriden by `tangerine-classic` solution.

### How does a package opt out of techstack

A package can opt out of the rules enforced by techstack by setting the `techstack` field to `off`
in its `package.json`.

```json
{
    "name": "package-a",
    "techstack": "off
}
```

In a repository, there might be certain old packages which do not adhere to any of the rules
enforced by techstack and hence have their `techstack` field set to `off`.

### How does a package ignore specific eslint and stricter rules from techstack

A package can ignore specific eslint and stricter rule by setting them in the `techstackIgnore`
field of package.json.

```json
 {
    "name" : "package-a"
    // ignored rules
    "techstackIgnore": {
        // list of eslint rules to ignore
        "eslint": ["rule1", "rule2"],

        // list of stricter rules to ignore
        "stricter": ["rule3", "rule4"],
    },
};
```
