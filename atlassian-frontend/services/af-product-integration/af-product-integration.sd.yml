name: atlassian frontend product integration service
description: Performs functions related to integration of atlassian-frontend branches into products
links:
  source:
    url: https://bitbucket.org/atlassian/atlassian-frontend
organization: 'UI Platform'
notifications:
  email: mblaszczyk@atlassian.com
loadBalancer:
  type: ALB
  single: true
requiresAsap: true
buildNumber: "${VERSION}"
computeClassification:
  dataType:
    - UGC/Primary # Receives repository related data for atlassian-frontend repo
    - PII/DirectRestrictedIdentifier # Receives repository data which can include bitbucket UUIDs
    - PII/DirectRestricted # Receives repository data which can include display name
    - Usage/DirectAction # Receives repository data when a user creates a PR
resources:
  - type: globaledge
    name: ingress
    attributes:
      routes:
        - match:
            prefix: '/webhooks'
            ip_whitelist:
              - public # This endpoint receives requests from Bitbucket
        - match:
            prefix: '/'
          route:
            cluster: blackhole

  - type: dynamo-db
    name: statuses
    attributes:
      HashKeyName: commitBranch
      HashKeyType: 'S'
      RangeKeyName: 'product'
      RangeKeyType: 'S'
      ReadWriteCapacityMode: ON_DEMAND
      dataType:
        - UGC/Primary # stores branch name (UGC) of atlassian-frontend repo branches
  - type: lambda
    name: af-product-integration
    attributes:
      private: true
      healthcheck: true
      runtime: nodejs12.x
      artefact: ${ARTEFACT}
      handler: dist/bundle.handler
      memory: 128
      timeout: 30
      concurrentExecutions: 10
      dataType:
        - UGC/Primary # Receives repository related data for atlassian-frontend repo
        - PII/DirectRestrictedIdentifier # Receives repository data which can include bitbucket UUIDs
        - Usage/DirectAction # Receives repository data when a user creates a PR
      loadBalancer:
        rules:
          - name: integratorstatus
            priority: 1001
            conditions:
              - Field: path-pattern
                Values: ['/integrator-status']
              - Field: http-request-method
                HttpRequestMethodConfig:
                  Values: ['POST']
          - name: webhooks
            priority: 1002
            conditions:
              - Field: path-pattern
                Values: ['/webhooks']
              - Field: http-request-method
                HttpRequestMethodConfig:
                  Values: ['POST']
