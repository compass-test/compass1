name: package ownership service
description: Conducts checks regarding the ownership of packages in Atlassian Frontend
links:
  source:
    url: https://bitbucket.org/atlassian/atlassian-frontend
organization: 'UI Platform'
notifications:
  email: uip-monorepo@atlassian.com
buildNumber: "${VERSION}"
loadBalancer:
  type: ALB
  single: true

requiresAsap: true

computeClassification:
  dataType:
    - PII/DirectRestrictedIdentifier
    - PII/DirectRestricted

resources:
  - type: globaledge
    name: ingress
    attributes:
      routes:
        - match:
            prefix: '/upload-metadata'
            ip_whitelist:
              - public # This endpoint receives requests from Bitbucket
        - match:
            prefix: '/'
          route:
            cluster: blackhole

  - type: dynamo-db
    name: contributors
    attributes:
      HashKeyName: staffId
      HashKeyType: S
      ReadWriteCapacityMode: ON_DEMAND
      dataType:
        - PII/DirectRestrictedIdentifier
        - PII/DirectRestricted

  - type: dynamo-db
    name: changed-packages
    attributes:
      HashKeyName: commit
      HashKeyType: S
      ReadWriteCapacityMode: ON_DEMAND
      dataType:
        - None

  - type: lambda
    name: package-ownership-lambda
    attributes:
      private: true
      healthcheck: true
      runtime: nodejs12.x
      artefact: ${ARTEFACT}
      handler: dist/bundle.handler
      memory: 128
      timeout: 30
      concurrentExecutions: 10
      dataType:
        - None
      loadBalancer:
        rules:
          - name: uploadmetadata
            priority: 1001
            conditions:
              - Field: path-pattern
                Values: ['/upload-metadata']
              - Field: http-request-method
                HttpRequestMethodConfig:
                  Values: ['POST']
          - name: ownershipcheck
            priority: 1002
            conditions:
              - Field: path-pattern
                Values: ['/ownership-check']
              - Field: http-request-method
                HttpRequestMethodConfig:
                  Values: ['GET']
