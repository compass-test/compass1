name: design system docs lambda
organization: UI Platform

notifications:
  email: eng-design-system@atlassian.com

buildNumber: "${VERSION}"

links:
  source:
    url: https://bitbucket.org/atlassian/atlassian-frontend
  healthcheck:
    uri: api/healthcheck

loadBalancer:
  type: ALB
  single: true

# For more infomation please see
# https://hello.atlassian.net/wiki/spaces/MICROS/pages/167213240/Service+descriptor+reference#scaling
scaling:
  metrics:
    # Default config taken from here:
    # https://hello.atlassian.net/wiki/spaces/MICROS/pages/167213712/HOWTO+Manage+the+scaling+rules+for+your+service#Default-rules
    CPUUtilization:
      Threshold:
        Lower: 45
        Upper: 70
      Period:
        Lower: 300
        Upper: 300
      EvaluationPeriods: 2

# Timeout set to 10 here to account for large payload pages like illustrations
# also ensures occassional link resolution tasks have time to resolve
resources:
  - type: lambda
    name: alblambda
    attributes:
      dataType:
        - Atlassian/Static # Serves assets from contentful
        - Security/Credential # JWTs are returned through the lambda endpoint
        - PII/DirectRestricted # Profile picture is passed along with the token
      private: false
      healthcheck: false
      runtime: nodejs12.x
      timeout: 20
      artefact: ${ARTEFACT_NAME}
      handler: functions/auth.handler
      memory: 256 # set higher temporarily to test performance on authenticated pages
      concurrentExecutions: 20
      loadBalancer:
        rules:
          - name: apiroute
            priority: 1001
            conditions:
              - Field: path-pattern
                Values: ['/api', '/api/*']

computeClassification:
  dataType:
    - None # Ec2 isn't utilized

environmentOverrides:
  stg-east:
    resources:
      - type: globaledge
        name: ingress
        attributes:
          domain:
            - api-staging.atlassian.design
          routes:
            - match:
                prefix: '/api/'
            - match:
                prefix: '/'
              route:
                cluster: blackhole
  prod-east:
    resources:
      - type: globaledge
        name: ingress
        attributes:
          domain:
            - api.atlassian.design
          routes:
            - match:
                prefix: '/api/'
            - match:
                prefix: '/'
              route:
                cluster: blackhole

alarms:
  overrides:
    LowSeverityAlarmWhenTooManyELB5xxErrors:
      MetricName: HTTPCode_ELB_5XX_Count
      Namespace: AWS/ApplicationELB
      Description: There have been a few errors returned in a short amount of time - follow this runbook to investigate https://hello.atlassian.net/wiki/spaces/DST/pages/974848489
      Threshold: 10
      Priority: Low
      Dimensions:
        - Name: LoadBalancer
          Value: { 'Fn::GetAtt': ['EnvironmentStack', 'LoadBalancerName'] }
      EvaluationPeriods: 1
      Period: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum

    HighSeverityAlarmWhenTooManyELB5xxErrors:
      MetricName: HTTPCode_ELB_5XX_Count
      Namespace: AWS/ApplicationELB
      Description: There have been a lot of errors returned in a short amount of time - follow this runbook to investigate https://hello.atlassian.net/wiki/spaces/DST/pages/974848489
      Threshold: 100
      Priority: High
      Dimensions:
        - Name: LoadBalancer
          Value: { 'Fn::GetAtt': ['EnvironmentStack', 'LoadBalancerName'] }
      EvaluationPeriods: 1
      Period: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
